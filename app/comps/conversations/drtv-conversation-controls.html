 <div class="control">
    <div cm-transparent-bg ng-show="bodyVisible" ng-click="toggleControls()"></div>
    <div ng-show="bodyVisible" class="body" data-qa="conversation-options-menu">
        <section class="body-group">
            {{heightState}}
            <label>{{'CONVERSATION.PLACEHOLDER.RECIPIENTS'|cmTranslate}}</label>
            <div class="recipients-list">
                <div class="scroller">
                    <div ng-click="manageRecipients()" ng-if="conversation.recipients.length == 1" class="add-new-recipients">
                        <cm-avatar cm-view="unknown"></cm-avatar>
                        {{'CONVERSATION.PLACEHOLDER.ADD_RECIPIENTS' | cmTranslate}}
                    </div>
                    <cm-avatar cm-data="recipient" cm-with-name="true" cm-view="hide-owner" ng-repeat="recipient in conversation.recipients"></cm-avatar>
                </div>
                <cm-add-button cm-icon="add-recipient" ng-click="manageRecipients()" cm-user-rights></cm-add-button>
            </div>
        </section>

        <section class="body-group no-border" ng-click="show_aspects = !show_aspects">
            <cm-security-indicator cm-data="conversation.securityAspects"/>
        </section>

        <section class="body-group no-border" ng-if="show_aspects">
            <cm-security-aspect ng-repeat="aspect in conversation.securityAspects.getNegativeAspects()" cm-data="aspect"></cm-security-aspect>
            <cm-security-aspect ng-repeat="aspect in conversation.securityAspects.getPositiveAspects()" cm-data="aspect"></cm-security-aspect>
        </section>

        <section class="body-group no-padding">
            <div class="label-with-checkbox">
                <label class="w20">{{'CONVERSATION.PLACEHOLDER.ENCRYPTION' | cmTranslate}}</label>
                <div class="w80 tac dib">
                    <button ng-click="toggleConversationEncryption()" data-qa="encryption-btn"><i class="fa cm-lg-icon cm-ci-color ml15" ng-class="{'cm-checkbox':!conversation.isEncrypted(), 'cm-checkbox-right':conversation.isEncrypted(), 'cm-grey':!isNew}" data-qa="icon-checkbox-encryption"></i></button>
                </div>
            </div>

            <div class="label-with-checkbox" ng-if="conversation.options.hasPassword && conversation.isEncrypted()">
                <label class="w20">{{'CONVERSATION.PLACEHOLDER.PASSCAPTCHA' | cmTranslate}}</label>
                <div class="w80 tac dib">
                    <button ng-click="toggleCaptcha()"><i class="fa cm-lg-icon cm-ci-color ml15" ng-class="{'cm-checkbox':!conversation.options.hasCaptcha, 'cm-checkbox-right':conversation.options.hasCaptcha, 'cm-grey':!isNew}" data-qa="icon-checkbox-passcaptcha"></i></button>
                </div>
            </div>

            <div ng-if="conversation.options.hasPassword && conversation.isEncrypted()">
                <div class="captcha" ng-if="conversation.options.hasCaptcha && isNew" data-qa="captcha-canvas">
                    <cm-captcha></cm-captcha>
                    <button class="refresh" ng-click="refreshCaptcha()" ng-if="isNew"><i class="fa cm-change"></i></button>
                    <p ng-if="!isNew">
                        <button ng-click="requestCaptcha()"><i class="fa cm-key"></i> {{"CONVERSATION.LABEL.REQUEST_CAPTCHA" | cmTranslate}}</button>
                    </p>
                    <p ng-if="!isNew">
                        <button ng-click="sendCaptcha()"><i class="fa cm-send"></i> {{"CONVERSATION.LABEL.SEND_CAPTCHA" | cmTranslate}}</button>
                    </p>
                </div>

                <div id="passwordInput">
                    <div class="captcha" ng-if="!isNew" data-qa="captcha-image">
                        <img cm-blob-image="conversation.passCaptcha" />
                    </div>

                    <div class="cm-form-group label-with-checkbox">
                        <label class="w20">{{'CONVERSATION.PLACEHOLDER.PASSWORD'|cmTranslate}}</label>
                        <div class="cm-form-control with-inputter w80" style="background-color:#fff" ng-class="{'with-inside-icon':!isNew}">
                            <input style="background-color:#fff" type="text" ng-model="conversation.password" placeholder="{{'CONVERSATION.PLACEHOLDER.PASSWORD'|cmTranslate}}" cm-adaptive-change cm-ios-focus="{fixedElements:'cm-header, cm-conversation-controls', scrollTop:true}" ng-focus="scrollToPassword()" />
                            <i class="fa cm-key fa-2x with-cursor" ng-click="decrypt()" ng-if="!isNew"></i>
                        </div>
                    </div>
                </div>

            </div>

            <div ng-if="conversation.options.showKeyInfo" style="text-align:center; cursor:pointer" cm-user-rights>
                <a href="#/settings/identity/keys">
                    {{'CONVERSATION.LABEL.KEY_GENERATION'|cmTranslate}}
                </a>
            </div>
        </section>

        <section class="cm-form-group body-group label-with-checkbox" ng-show="isNew">
            <label class="w20">{{'CONVERSATION.PLACEHOLDER.SUBJECT' | cmTranslate}}</label>
            <div class="cm-form-control with-inputter w80" style="background-color:#fff">
                <input data-qa="input-subject" style="background-color:#fff" type="text" ng-model="conversation.subject" placeholder="{{'CONVERSATION.PLACEHOLDER.NO_SUBJECT'|cmTranslate}}" cm-adaptive-change  cm-ios-focus="{fixedElements:'cm-header, cm-conversation-controls', scrollTop:true}" />
            </div>
        </section>

        <button ng-click="toggleControls('close');decrypt()" class="cm-btn" ng-if="!isNew" data-qa="btn-save-options">{{'CONVERSATION.CONTROL.CLOSE'|cmTranslate}} <i class="fa cm-close cm-lg-icon"></i></button>
        <button ng-click="toggleControls('close',true)" class="cm-btn" ng-if="isNew" data-qa="btn-save-options">{{'CONVERSATION.CONTROL.SAVE'|cmTranslate}} <i class="fa cm-checker cm-lg-icon"></i></button>
    </div>

    <div class="cm-bar" cm-rubber-space ng-click="toggleControls()" data-qa="conversation-options-bar">
        <div cm-weight="1" class="grip-left">
            <i class="fa cm-grip"></i>
        </div>
        <div cm-weight="8" class="cm-bar-infos">
            <span ng-bind-html="conversation.subject||'CONVERSATION.PLACEHOLDER.NO_SUBJECT'|cmParse"></span>
            <cm-lock-level cm-level="conversation.lockStatus.level"></cm-lock-level>
            <cm-recipient-counter>{{conversation.recipients.length||0}}</cm-recipient-counter>
        </div>
        <div cm-weight="1"></div>
    </div>
</div>