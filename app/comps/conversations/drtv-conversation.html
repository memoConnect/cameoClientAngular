<section class="body-group recipients" ng-if="conversation.state.is('new') || !conversation.state.is('new') && conversation.recipients.length > 1">
    <label ng-click="toggleRecipientView()">
        <i class="fa cm-lg-icon" ng-class="{'cm-grid':!showGrid,'cm-menu-weight':showGrid}"></i>
        {{'CONVERSATION.PLACEHOLDER.RECIPIENTS'|cmTranslate}}
        <span class="recipients-counter">({{conversation.recipients.length-1}})</span>
        <span class="recipient-name" ng-show="showGrid">{{recipientName}}</span>
    </label>
    <div class="recipients-list">
        <div
            class="scroller"
            ng-class="{
                'show-scrollbar': conversation.recipients.length > 7 && showGrid,
                'disable-scrollbar': !showGrid
            }">
            <div
                class="add-new-recipients"
                ng-click="goto('conversation/'+(conversation.id||'new')+'/recipients')"
                ng-if="conversation.recipients.length == 1 && conversation.state.is('new')">
                <cm-avatar cm-view="unknown"></cm-avatar>
                <span>{{'CONVERSATION.PLACEHOLDER.ADD_RECIPIENTS'|cmTranslate}}</span>
            </div>
                <cm-avatar
                    cm-data="recipient"
                    ng-click="showName(recipient)"
                    ng-class="{
                        'name-shown': recipientName == recipient.getDisplayName()
                    }"
                    ng-repeat="recipient in conversation.recipients|cmHideAppOwner|orderBy:'getDisplayName()':false"
                    cm-first-of-repeat="showName(recipient)"
                    ng-show="showGrid">
                </cm-avatar>
            <cm-recipients-comma-seperated cm-data="conversation" ng-show="!showGrid"></cm-recipients-comma-seperated>
        </div>
        <div
            class="cm-add-button"
            ng-click="goto('conversation/'+(conversation.id||'new')+'/recipients')"
            cm-user-rights>
            <i
                class="fa"
                ng-class="{
                    'cm-add-recipient':conversation.recipients.length == 1,
                    'cm-list':conversation.recipients.length > 1
                }"></i>
        </div>
    </div>
</section>

<section
    class="body-group subject"
    ng-if="conversation.state.is('new') || !conversation.state.is('new') && conversation.subject">
    <div
        class="cm-form-group"
        ng-if="!conversation.state.is('new') && conversation.subject">
        <label class="w20">{{'CONVERSATION.PLACEHOLDER.SUBJECT' | cmTranslate}}</label>
        <div
            data-qa="text-subject"
            class="cm-form-control white-control w80"
            ng-bind-html="conversation.subject|cmParse"></div>
    </div>
    <div
        class="cm-form-group"
        ng-if="conversation.state.is('new')">
        <label class="w20">{{'CONVERSATION.PLACEHOLDER.SUBJECT' | cmTranslate}}</label>
        <div class="cm-form-control white-control with-inputter w80">
            <input
                type="text"
                data-qa="input-subject"
                ng-model="conversation.subject"
                placeholder="{{'CONVERSATION.PLACEHOLDER.NO_SUBJECT'|cmTranslate}}"
                cm-adaptive-change
            />
        </div>
    </div>
</section>

<button class="cm-btn" ng-if="conversation && conversation.state.is('loadedMessages')" ng-show="conversation.numberOfMessages != conversation.messages.length" ng-click="loadPreviousMessages()">
    {{'CONVERSATION.LABEL.LOAD_PREVIOUS'|cmTranslate}}
</button>

<div id="conversation-top"></div>

<div
    ng-repeat="message in (filteredData = (conversation.messages | orderBy:'created':false))"
    cm-scroll-to="{anchor:'#conversation-bottom',force:'bottom'}">
    <cm-date-seperator cm-timestamp="message.created" cm-timestamp-prev="filteredData[$index - 1].created">
        <cm-time-converter cm-timestamp="message.created" cm-special-type="'date-seperator'"></cm-time-converter>
    </cm-date-seperator>
    <!-- moep - don't delete - ask empu^^ -->
    <cm-message cm-data="message" cm-data-conversation="conversation"></cm-message>
</div>

<div id="conversation-bottom"></div>

<div class="answer clearfix" id="files-droparea">
    <div class="wrap">
        <div class="btns-left">
            <cm-files ng-model="files" data-qa="attachments-btn">
                <i class="fa cm-attachment"></i>
                <div cm-user-rights>
                    <cm-file-choose cm-droparea="files-droparea"></cm-file-choose>
                    <cm-files-preview></cm-files-preview>
                    <cm-choose-source cm-options="{tooltip:'up'}"></cm-choose-source>
                </div>
                <div
                    data-qa="btn-fast-registration"
                    class="webreader-uploading"
                    cm-user-rights="showForGuest"
                    ng-click="openFastRegister()"></div>
            </cm-files>
        </div>

        <div class="message" data-qa="answer-ctn">
            <textarea
                id="emoji-textarea"
                data-qa="input-answer"
                ng-model="newMessageText"
                cm-resize-textarea
                cm-max-rows="8"
                input
                ></textarea>
            <div class="inputter"></div>
        </div>

        <div class="btns-right">
            <cm-emoji-handler></cm-emoji-handler>

            <div class="post-wrap" data-qa="btn-send-answer" ng-click="send()">
                <i
                        class="fa cm-post with-cursor {{conversation.lockStatus.class}}-wrap"
                        ng-class="{
                    'cm-post-idle':isSending,
                    'cm-post-attention':isSendingAbort
                }"></i>
            </div>
        </div>
    </div>
    <cm-emoji-list ng-model="newMessageText" cm-textarea="emoji-textarea"></cm-emoji-list>
</div>